@inject IStandingsService StandingsService

<MudPaper Elevation="1" Class="pa-4 standings-card">
    <MudStack Spacing="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudText Typo="Typo.h5" Class="font-weight-semibold">Tabell</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                @if (_isLoading)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                }
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                           Disabled="_isLoading" OnClick="@RefreshAsync">
                    Uppdatera
                </MudButton>
            </MudStack>
        </MudStack>

        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Dense="true">
                @_errorMessage
            </MudAlert>
        }

        <div class="standings-desktop">
            <MudTable Items="_rows" Hover="true" Dense="true" Class="standings-table" Loading="_isLoading">
                <HeaderContent>
                    <MudTh>#</MudTh>
                    <MudTh>Spelare</MudTh>
                    <MudTh class="text-center">Matcher</MudTh>
                    <MudTh class="text-center">Vinster</MudTh>
                    <MudTh class="text-center">Förluster</MudTh>
                    <MudTh class="text-center">Vinst %</MudTh>
                    <MudTh class="text-center">
                        <MudTooltip Text="@EloDescription">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1">
                                <MudText>Ranking</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Secondary" Size="Size.Small" />
                            </MudStack>
                        </MudTooltip>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="#">@context.Position</MudTd>
                    <MudTd DataLabel="Spelare">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudAvatar Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                @context.Initials
                            </MudAvatar>
                            <MudLink Href="@($"/players/{context.PlayerId}")" Underline="Underline.None">
                                <MudText Color="Color.Primary">@context.Name</MudText>
                            </MudLink>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Matcher" Class="text-center">@context.MatchesPlayed</MudTd>
                    <MudTd DataLabel="Vinster" Class="text-center">@context.Wins</MudTd>
                    <MudTd DataLabel="Förluster" Class="text-center">@context.Losses</MudTd>
                    <MudTd DataLabel="Vinst %" Class="text-center">@context.WinPercentage.ToString("P0")</MudTd>
                    <MudTd DataLabel="Ranking" Class="text-center">@context.Rating.ToString("F0")</MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Typo="Typo.body2" Class="ma-4" Color="Color.Secondary">
                        Inga matcher registrerade ännu. Var först med att logga en match!
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        </div>

        <div class="standings-mobile">
            <MudStack Spacing="0">
                @* Header row *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="py-2 px-1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="min-width: 28px;">#</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="flex: 1; padding-left: 40px;">Spelare</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Style="min-width: 60px;" Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Poäng</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Secondary"
                                       Variant="Variant.Text" OnClick="@ToggleRankingInfo" />
                    </MudStack>
                </MudStack>
                <MudDivider />
                @if (_showRankingInfo)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="px-1 pb-2">
                        @EloDescription
                    </MudText>
                    <MudDivider />
                }

                @foreach (var row in _rows)
                {
                    <MudStack Spacing="1" Class="py-3 px-1">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Style="min-width: 28px; font-weight: 600;">
                                @row.Position
                            </MudText>
                            <MudAvatar Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                                @row.Initials
                            </MudAvatar>
                            <MudLink Href="@($"/players/{row.PlayerId}")" Underline="Underline.None" Style="flex: 1;">
                                <MudText Typo="Typo.body1" Class="font-weight-medium">@row.Name</MudText>
                            </MudLink>
                            <MudText Typo="Typo.body1" Class="font-weight-bold" Style="min-width: 44px; text-align: right;">
                                @row.Rating.ToString("F0")
                            </MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" Class="pl-10">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@row.Wins–@row.Losses</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">·</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@row.WinPercentage.ToString("P0") vinst</MudText>
                        </MudStack>
                    </MudStack>
                    <MudDivider />
                }
            </MudStack>
        </div>
    </MudStack>
</MudPaper>

@code {
    private readonly List<StandingsRowViewModel> _rows = [];
    private const string EloDescription =
        "Ranking bygger på ELO som är ett poängsystem som jämför spelares relativa styrka. " +
        "Efter varje match justeras bådas rating beroende på förväntat resultat: " +
        "vinner du mot en stark motståndare ökar din rating mer, förlorar du mot en svag " +
        "minskar den mer. Systemet balanserar sig över tid.";

    private bool _isLoading;
    private string? _errorMessage;
    private bool _showRankingInfo;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    public async Task RefreshAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (_isLoading)
        {
            return;
        }

        _errorMessage = null;
        _isLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var standings = await StandingsService.GetStandingsAsync();
            var sortedStandings = standings
                .OrderByDescending(row => row.CurrentRating)
                .ThenBy(row => row.PlayerName, StringComparer.OrdinalIgnoreCase)
                .ToList();

            var updatedRows = sortedStandings
                .Select((row, index) => new StandingsRowViewModel(
                    index + 1,
                    row.PlayerId,
                    row.PlayerName,
                    BuildInitials(row.PlayerName),
                    row.MatchesPlayed,
                    row.Wins,
                    row.Losses,
                    row.WinPercentage,
                    row.CurrentRating))
                .ToList();

            _rows.Clear();
            _rows.AddRange(updatedRows);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load standings: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string BuildInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "?";
        }

        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (parts.Length == 0)
        {
            return "?";
        }

        if (parts.Length == 1)
        {
            var segment = parts[0];
            return segment.Length switch
            {
                0 => "?",
                1 => segment.ToUpperInvariant(),
                _ => string.Concat(char.ToUpperInvariant(segment[0]), char.ToUpperInvariant(segment[1]))
            };
        }

        var initials = string.Concat(parts.Take(2).Select(p => char.ToUpperInvariant(p[0])));
        return initials.Length == 0 ? "?" : initials;
    }

    private void ToggleRankingInfo()
    {
        _showRankingInfo = !_showRankingInfo;
    }

    private sealed record StandingsRowViewModel(
        int Position,
        Guid PlayerId,
        string Name,
        string Initials,
        int MatchesPlayed,
        int Wins,
        int Losses,
        double WinPercentage,
        double Rating);
}
