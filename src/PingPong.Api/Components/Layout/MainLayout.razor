@inherits LayoutComponentBase
@inject IDialogService Dialog
@inject UserIdentityService IdentityService

<MudThemeProvider Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h6" Class="ml-3">Pingis</MudText>
        <MudSpacer />
        <MudMenu AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudIconButton Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" />
            </ActivatorContent>
            <ChildContent>
                @if (!string.IsNullOrWhiteSpace(_identityName))
                {
                    <MudText Class="px-4 py-2" Typo="Typo.body2">Din spelare: <strong>@_identityName</strong></MudText>
                }
                else
                {
                    <MudText Class="px-4 py-2" Typo="Typo.body2" Color="Color.Secondary">Ingen spelare vald</MudText>
                }
                <MudDivider />
                <MudMenuItem OnClick="@OpenIdentityDialog">Byt spelareâ€¦</MudMenuItem>
                <MudMenuItem OnClick="@ForgetIdentity" Disabled="string.IsNullOrWhiteSpace(_identityName)">GlÃ¶m val</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" Elevation="1" Variant="@DrawerVariant.Responsive" Color="Color.Primary" Breakpoint="Breakpoint.Md">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6" Class="font-weight-bold">Pingis</MudText>
        </MudDrawerHeader>
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-6">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    Ett ohanterat fel har intrÃ¤ffat.
    <a href="." class="reload">Ladda om</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private bool _drawerOpen = true;
    private string? _identityName;

    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#33BBFF",           // Wint blue-03 (main brand color)
            Secondary = "#807D75",          // Wint gray-02 (muted text)
            Tertiary = "#26BF73",           // Wint green-03 (accent)
            Info = "#0C9EF2",               // Wint blue-02
            Success = "#26BF73",            // Wint green-03
            Warning = "#FFB219",            // Wint yellow-03
            Error = "#E62253",              // Wint red-04
            AppbarBackground = "#1F4266",   // Wint blue-01 (darker blue for header)
            DrawerBackground = "#1F4266",   // Wint blue-01
            DrawerText = "#FFFFFF",
            DrawerIcon = "#FFFFFF",
            Background = "#FFFFFF",
            Surface = "#FFFFFF",
            TextPrimary = "#272727",        // Wint gray-01
            TextSecondary = "#807D75",      // Wint gray-02
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#66CCFF",            // Wint blue-04
            Secondary = "#A7A59D",          // Wint gray-03
            Tertiary = "#41D980",           // Wint green-04
        },
        Typography = new Typography
        {
            Default = new DefaultTypography
            {
                FontFamily = ["Roboto", "Helvetica", "Arial", "sans-serif"],
            }
        }
    };

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadIdentityAsync();
            
            var tutorialSeen = await IdentityService.GetTutorialSeenAsync();
            if (!tutorialSeen)
            {
                var options = new DialogOptions { CloseOnEscapeKey = true, NoHeader = false };
                var result = await Dialog.ShowAsync<IdentityTutorialDialog>("VÃ¤lj din spelare", options);
                await result.Result;
                await LoadIdentityAsync();
            }
            
            StateHasChanged();
        }
    }

    private async Task LoadIdentityAsync()
    {
        _identityName = await IdentityService.GetIdentityNameAsync();
    }

    private async Task OpenIdentityDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, NoHeader = false };
        var result = await Dialog.ShowAsync<IdentityTutorialDialog>("VÃ¤lj din spelare", options);
        await result.Result;
        await LoadIdentityAsync();
        StateHasChanged();
    }

    private async Task ForgetIdentity()
    {
        await IdentityService.ClearIdentityAsync();
        await LoadIdentityAsync();
        StateHasChanged();
    }
}
